@{
    ViewData["Title"] = ViewBag.Title;
    Layout = "~/Views/Shared/_Layout.cshtml";
    var session = Guid.NewGuid();
}

<h1>@ViewBag.Title</h1>

@using (Html.BeginForm())
{
    <label>@ViewBag.Label</label>
    <br/>
    <input type="hidden" id="session" name="session" value="@session"/>
    <button type="button" class="btn btn-info" onclick="uploadForm();">Отправить</button>
}
<br/>
<br/>
<div id="progresses"></div>

<script type="text/javascript" charset="utf-8">
    function uploadForm() {
        var formData = new FormData();
        var session = document.getElementById("session");
        formData.append("session", session.value);

        $.ajax(
            {
                url: "@ViewBag.UploadLink",
                data: formData,
                cache: false,
                contentType: false,
                processData: false,
                type: "POST",
                success: function(data) {
                    alert("Complete");
                },
                error: function(jqXHR, exception) {
                    alert("Error");
                },
            }
        );
    };

    (function() {
        var hubConnection = new signalR.HubConnectionBuilder()
            .withUrl("/progress")
            .withAutomaticReconnect()
            .build();

        var appendProgress = function(id) {
            $("#progresses").append('<div id="' +
                id +
                '" class="progress"><div id="progress" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100" style="width: 0%;"> \
                <div id="label" class="control-label">0%</div> \
                </div></div>');
        };

        hubConnection.on("Progress",
            function(progress, id, session) {
                if (session !== '@session') return;
                if (!$('#' + id).length) appendProgress(id);
                $('#' + id + ' #progress').css({ width: progress + "%" });
                $('#' + id + ' #label').html(progress.toFixed(1) + "%");
            });

        hubConnection.on("Init",
            function(id, session) {
                if (session !== '@session') return;
                if (!$('#' + id).length) appendProgress(id);
            });

        hubConnection.start();
    })();

</script>