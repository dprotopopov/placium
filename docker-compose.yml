version: "3.9"
networks:
  placium:
    name: placium_dev
    driver: bridge 

services:
  webapp-placium:
    container_name: webapp-placium
    build:
      context: .
      dockerfile: Placium.WebApp/Dockerfile
    ports:
      - "15000:5000"
      - "15001:5001"
    depends_on:
      - postgres-placium
      - postgis-placium
      - sphinx-placium
    restart: always
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ConnectionStrings__FiasConnection: "Host=postgres-placium;Port=5432;Database=fias_db;Username=${POSTGRES_USER};Password=${POSTGRES_PASSWORD};Command Timeout=0"
      ConnectionStrings__OsmConnection: "Host=postgis-placium;Port=5432;Database=osm_db;Username=${POSTGRES_USER};Password=${POSTGRES_PASSWORD};Command Timeout=0"
      ConnectionStrings__SphinxConnection: "Host=sphinx-placium;Port=9306;Command Timeout=0"
      UploadConfig__Path: "/upload"
      Kestrel__Endpoints__Http__Url: http://0.0.0.0:5000
      Kestrel__Endpoints__Https__Url: http://0.0.0.0:5001
    volumes:
      - ../upload:/upload/
    networks:
      - placium
    logging:
      driver: none

  postgres-placium:
    image: "postgres"
    container_name: postgres-placium
    ports:
      - "15432:5432"
    restart: always
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: fias_db
      PGDATA: /var/lib/postgresql/data
    volumes:
      - ../postgres/data:/var/lib/postgresql/data
    networks:
      - placium
    logging:
      driver: none

  postgis-placium:
    image: "postgis/postgis"
    container_name: postgis-placium
    ports:
      - "25432:5432"
    restart: always
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: osm_db
      PGDATA: /var/lib/postgresql/data
    volumes:
      - ../postgis/data:/var/lib/postgresql/data
    networks:
      - placium
    logging:
      driver: none

  sphinx-placium:
    image: "stefobark/sphinxdocker"
    container_name: sphinx-placium
    ports:
      - "19306:9306"
    restart: always
    volumes:
      - ../sphinx/conf:/etc/sphinxsearch/
      - ../sphinx/data/:/var/lib/sphinx/data/
    networks:
      - placium
    logging:
      driver: none
